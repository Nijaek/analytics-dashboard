(function() {
"use strict";
var API_KEY = "";
var API_URL = "";
var BATCH_SIZE = 10;
var FLUSH_INTERVAL = 2000;
var MAX_RETRIES = 3;
var queue = [];
var flushTimer = null;
var sessionId = "";
var distinctId = null;
var userProperties = {};
function generateId() {
return "xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g, function(c) {
var r = Math.random() * 16 | 0;
return (c === "x" ? r : (r & 0x3 | 0x8)).toString(16);
});
}
function getSessionId() {
if (sessionId) return sessionId;
try {
sessionId = sessionStorage.getItem("_tk_sid") || "";
if (!sessionId) {
sessionId = "sess_" + generateId();
sessionStorage.setItem("_tk_sid", sessionId);
}
} catch (e) {
sessionId = "sess_" + generateId();
}
return sessionId;
}
function flush() {
if (queue.length === 0) return;
var events = queue.splice(0, BATCH_SIZE);
send(events, 0);
}
function send(events, attempt) {
var xhr = new XMLHttpRequest();
xhr.open("POST", API_URL + "/api/v1/events/ingest");
xhr.setRequestHeader("Content-Type", "application/json");
xhr.setRequestHeader("X-API-Key", API_KEY);
xhr.onreadystatechange = function() {
if (xhr.readyState !== 4) return;
if (xhr.status >= 200 && xhr.status < 300) return;
if (attempt < MAX_RETRIES) {
var delay = Math.pow(2, attempt) * 1000;
setTimeout(function() { send(events, attempt + 1); }, delay);
}
};
xhr.send(JSON.stringify({ events: events }));
}
function scheduleFlush() {
if (flushTimer) return;
flushTimer = setTimeout(function() {
flushTimer = null;
flush();
}, FLUSH_INTERVAL);
}
function enqueue(eventName, properties) {
var evt = {
event: eventName,
properties: properties || null,
session_id: getSessionId(),
page_url: window.location.href,
referrer: document.referrer || null,
timestamp: new Date().toISOString()
};
if (distinctId) {
evt.distinct_id = distinctId;
}
queue.push(evt);
if (queue.length >= BATCH_SIZE) {
flush();
} else {
scheduleFlush();
}
}
var lastPath = window.location.pathname;
function checkRouteChange() {
if (window.location.pathname !== lastPath) {
lastPath = window.location.pathname;
enqueue("page_view", { path: lastPath });
}
}
var origPushState = history.pushState;
var origReplaceState = history.replaceState;
history.pushState = function() {
origPushState.apply(this, arguments);
checkRouteChange();
};
history.replaceState = function() {
origReplaceState.apply(this, arguments);
checkRouteChange();
};
window.addEventListener("popstate", checkRouteChange);
var tracker = {
event: function(name, properties) {
enqueue(name, properties);
},
identify: function(id, props) {
distinctId = id;
if (props) userProperties = props;
enqueue("$identify", Object.assign({ distinct_id: id }, props || {}));
},
reset: function() {
distinctId = null;
userProperties = {};
sessionId = "";
try { sessionStorage.removeItem("_tk_sid"); } catch (e) {}
},
flush: flush
};
function init() {
var scripts = document.getElementsByTagName("script");
for (var i = 0; i < scripts.length; i++) {
var s = scripts[i];
if (s.getAttribute("data-project")) {
API_KEY = s.getAttribute("data-project");
API_URL = s.getAttribute("data-api-url") || s.src.replace(/\/sdk\.js.*/, "");
break;
}
}
if (API_KEY) {
enqueue("page_view", { path: window.location.pathname });
}
}
if (typeof window !== "undefined") {
window.tracker = tracker;
if (document.readyState === "complete" || document.readyState === "interactive") {
init();
} else {
document.addEventListener("DOMContentLoaded", init);
}
window.addEventListener("beforeunload", flush);
}
})();